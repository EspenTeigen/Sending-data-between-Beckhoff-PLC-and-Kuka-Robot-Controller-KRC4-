\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{titlepic}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{amsmath}


\titlepic{\includegraphics[width=\textwidth]{pictures/logo.jpg}}
\title{Sending data between Beckhoff PLC and Kuka Robot Controller(KRC4)}
\author{Espen Teigen }
\date{March 2019}




\begin{document}

\maketitle

    Github: https://github.com/EspenTeigen/Kuka-KR-C4-commissioning

\newpage
\section{Setting up the PLC to send and receive data with controller}
\subsection{Opening a project and getting to know the main PLC components}
First you have to open Twincat XAE. you will get this window

\begin{figure}[!h]
    \centering
    \includegraphics[width=\textwidth]{pictures/TC3_overview/TC3_startscreen.png}
    \caption{Twincat startscreen}
    \label{fig:my_label}
\end{figure}

Select open project and in the folder TwinCAT project, you will find the microsoft visual studio solution \textbf{Kuka\_robot\_project\_twinsafe\_modbus}. If the project is not found, you can get a copy from \href{https://github.com/EspenTeigen/Kuka-KR-C4-commissioning}{\underline{github}}

\newpage
You will get this view

\begin{figure}[!h]
    \centering
    \includegraphics[width=\textwidth]{pictures/TC3_overview/TC3_project_view.png}
    \caption{Project view}
    \label{fig:my_label2}
\end{figure}

The most interesting part off the project tree is the PLC, so expand that part. 
\newpage
We can now take a look at the different parts that are relevant for data transmission.

\begin{figure}[!h]
    \centering
    \includegraphics[width=\textwidth]{pictures/TC3_overview/TC3_PLC_expanded.png}
    \caption{Caption}
    \label{fig:my_label}
\end{figure}

\newpage

\subsubsection{KukaPLC Project}
\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.7]{pictures/TC3_overview/TC3_KukaPLC.png}
    \caption{Caption}
    \label{fig:my_label}
\end{figure}
This is the entire PLC project, and are pre-configured to transfer data from the force-torque sensor to the robot controller. It is in this project we will set up our data transfer.  

\newpage

\subsubsection{POUs}
\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.7]{pictures/TC3_overview/TC3_POUs.png}
    \caption{}
    \label{fig:my_label}
\end{figure}

POUs are where at the programs, function blocks and functions are placed. You can chose between all the IEC 61131-3 standard programming languages. I will be using structured text. 

\newpage

\subsubsection{PLCTask}
\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.7]{pictures/TC3_overview/TC3_PLCTask.png}
    \caption{}
    \label{fig:my_label}
\end{figure}

To understand this, i have to explain what a task is. A task is controlling the timing of how often the program should be run. You can also configure the priority of how the program should be run. If the program block is of utmost importance, and must be completed within a certain time limit, you will give it a suiting priority. 
\\
\\
PLCtask is a task that I made, and are used for this PLC. Every program that are going to be run in the PLC is timed by this task, and has to be added to it. 


\newpage

\subsubsection{KukaPLC instance}
\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.7]{"pictures/TC3_overview/TC3_KukaPLC Instance".png}
    \caption{}
    \label{fig:my_label}
\end{figure}

This is where you tie you're inputs and outputs to be transferred to and from the robot controller. When you create inputs and outputs in the PLC-program, they will end up here, and you have to link them to the module that transfer the data. Do not fret, I will describe this in a better manner later in the document. 

\newpage

\subsection{Creating a new program}


\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/create_POU(1)".png}
    \caption{Start by right-clicking on the POUs-folder and select add-POU}
    \label{fig:my_label}
\end{figure}

\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/POU name(2)".png}
    \caption{Give the program a name, and make sure you create a program, and that it is structured text}
    \label{fig:my_label}
\end{figure}

\newpage

\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/create IO(3)".png}
    \caption{Now we are ready to write a program}
    \label{fig:my_label}
\end{figure}

\noindent
\textcolor{blue}{PROGRAM}  demonstration is the name of the program
\\\\
\textcolor{blue}{VAR} and \textcolor{blue}{END\_VAR} denotes where you declare variables
\\\\
testVarOutput \textcolor{blue}{AT} \textcolor{purple}{\%Q*} : \textcolor{blue}{DWORD :=} 0;
\\
testVarOutput is the variable name, \textcolor{blue}{AT} tells the compiler that this should be attached to something. \textcolor{purple}{\%Q} tells the compiler that it should be an output, and the asterix * is telling the compiler that it can choose where in memory the data should be saved.    
\\\\
The reason we are using DWORD is because the ethercat bridge is configured to use it. The use of anything else will give a compiler error. 
\\\\
For the variable testVarInput it is the same, except we are using \textcolor{purple}{I} to tell the compiler that it is an input.
\\\\
Lastly I have just written a short code that will iterate trough all the values until the variable overflows and start at zero again. After we have linked the output to the bridge, the value will be transferred to the robot controller every iteration.

\subsection{Connecting the program to the PLC-task}

 Now we have to connect our program to the PLC-task, otherwise it will not be executed. 
 
 \begin{figure}[!h]
     \centering
     \includegraphics[scale=0.5]{"pictures/Creating program/add to task(4)".png}
     \caption{Adding the program to the PLC-task}
     \label{fig:my_label}
 \end{figure}

\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.4]{"pictures/Creating program/select task(5)".png}
    \caption{Select our program to be added to task and click OK}
    \label{fig:my_label}
\end{figure}

\newpage

Ok, just a few more steps. To get our input and output added to the instances, we have to build the PLC-program. 

\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/build(6)".png}
    \caption{Right click on KukaPLC project and select build}
    \label{fig:my_label}
\end{figure}



\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/Instance(7)".png}
    \caption{And now we can see the input and output we created in the KukaPLC instance}
    \label{fig:my_label}
\end{figure}

\newpage

\subsection{Linking of variables to bridge}

And to get the data transferred, we have to link this instances to the ethercat-bridge inside the controller. Double-click the demonstration.testVarInput.


\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/link input(8)".png}
    \caption{We start by linking the input. Click the link to button}
    \label{fig:my_label}
\end{figure}

A new window opens, this shows everything in the system you can link this variable to. If the variable type was BOOL, we could have linked this to a regular input or output. But we are linking this to the ethercat-bridge in the controller. This is the Box 9 (KRC4 secondary EL6695-1001). 

\begin{figure}[!h]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/link input(9)".png}
    \caption{I am choosing the first DWORD, but you could use anyone }
    \label{fig:my_label}
\end{figure}

\newpage

We have successfully(I hope) linked the variable to the ethercat-bridge, and after upload to the PLC we can pull the values from the controller from this variable.
\\\\
Next step is to link the output variable to the ethercat-bridge so we can send values to the robot controller. 
\\\\
Start by double-clicking demonstration.TestVarOut located under PLCTask Outputs and click the Link to button(like you did when linking the input).
\\\\


\begin{figure}[h!]
    \centering
    \includegraphics[scale=0.5]{"pictures/Creating program/link output(11)".png}
    \caption{Since I already have used the six first outputs to the data transfer from the force-torque sensor, we have to select the 6 output.}
    \label{fig:my_label}
\end{figure}

Press OK, and we have also linked our output variable to be sent to the controller. The last step is to download the program to the PLC.

\newpage

\subsection{Downloading the program to the PLC}



\begin{figure}[h!]
    \centering
    \includegraphics[scale=0.8]{"pictures/Creating program/upload(1)".png}
    \caption{Up in the left area of TwinCAT, you can see this button. Push it, just do it, i dare you}
    \label{fig:my_label}
\end{figure}

\begin{figure}[h!]
    \centering
    \includegraphics{"pictures/Creating program/upload(2)".png}
    \caption{Press OK}
    \label{fig:my_label}
\end{figure}

\begin{figure}[h!]
    \centering
    \includegraphics{"pictures/Creating program/upload(3)".png}
    \caption{And press OK again}
    \label{fig:my_label}
\end{figure}

You have now downloaded the program to the PLC, the next step is to configure Work Visual so the controller can receive the values we are sending to it.

\newpage

\section{Configuration of the robot controller to send and receive values to and from the PLC}
So. Lets open Work Visual, and getting started with the configuration to send and receive data. 

\subsection{Getting Work Visual up and running}

\subsection{Linking IO's}

\end{document}
